pipeline {
    agent any
    stages {    
         stage('Compile') {
            steps {
                script {
                    dir('DevOps_Project')
                    {sh 'mvn compile'}
                }
            }
        }
        //stage('Junit/Mock') {
          //    steps {
            //     script {
              //      dir('DevOps_Project')
                //    {sh 'mvn test '}
                //}
            //}
        //}
          stage('Build') {
              steps {
                 script {
                    dir('DevOps_Project')
                    {sh 'mvn package -Dmaven.test.skip=true'}
                }
            }
        } 
        
        
            stage("Docker build") {
            steps {
                dir('DevOps_Project')
                { 
                sh 'docker build -t fatma721/devops_project .'
                sh 'docker tag fatma721/devops_project fatma721/devops_project:latest'}
            }
        }
        
        stage("Docker Login") {
            steps {
                withCredentials([usernamePassword(credentialsId: 'DOCKER', usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                    sh "docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD"
                }
            }
        }
         stage("Push Image to Docker Hub") {
            steps {
                sh 'docker push fatma721/devops_project:latest'
            }
        }

        stage('docker compose') {
              steps{
                  dir('DevOps_Project')
                  {sh 'docker compose up -d'}
              }
          }
     //stage('SONARQUBE') {
            //steps {
                //script {
                //    dir('DevOps_Project')
              //      {sh 'mvn sonar:sonar -Dsonar.login=squ_036b7cd4a30da2a71a44697198f2f661863e1458'}
            //    }
          //  }
        //}
       // stage('Nexus'){
         //     steps {
           //      script {
             //       dir('DevOps_Project')
               //     {sh 'mvn deploy -Dmaven.test.skip=true '}
                //}
            //} 
        //}
     
}
     //post {
       // success {
         //   emailext (
           //     subject: 'Construction réussie',
             //   body: 'La construction du projet a réussi. Tout est en ordre!',
               // to: 'fatma.trabelsi@esprit.tn'
            //)
        //}
        //failure {
          //  emailext (
            //    subject: 'Construction échouée',
              //  body: 'La construction du projet a échoué. Veuillez vérifier les logs.',
                //to: 'fatma.trabelsi@esprit.tn'
            //)
        //}
       //}

}
